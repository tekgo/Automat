<!DOCTYPE html>
<html>
<head>
	<title>Automat Testing Ground</title>
<script>

	class Automat {
		constructor(size, comparatorFunc) {
			this.size = size;
			this.data = new Uint32Array(size * size);
			this.nullData = 0xFF808080;
			this.comparatorFunc = comparatorFunc;

			this.randomize();
		}

		getValue(x,y) {
			let size = this.size;
			if (x < 0 || y < 0 || x >= size || y >= size) {
				return this.data[((x + size) % size) + (((y + size) % size) * size)]
			}
			return this.data[x + (y * size)];
		}

		setValue(x,y, value) {
			let size = this.size
			if (x < 0 || y < 0 || x >= this.size || y >= this.size) {
				return this.data[((x + size) % size) + (((y + size) % size) * size)] = value;
			}
			return this.data[x + (y * size)] = value;
		}

		tick() {
			let size = this.size;
			let newData = new Uint32Array(size * size);

			for (var i = 0; i < (size * size); i++) {
				let x = i % size;
				let y = Math.floor(i / size);
				newData[i] = this.comparator(x,y,this.getKernel(x,y));
			}
			this.data = newData
		}

		getKernel(x,y) {
			let values = [];

			for (var i = y - 1; i <= y + 1; i++) {
				for (var j = x - 1; j <= x + 1; j++) {
					values.push(this.getValue(j,i));
				}
			}

			return values;
		}

		comparator(x, y, kernel) {
			return this.comparatorFunc(x, y, kernel);
		}

		render() {
			let size = this.size;
			let imageData = new ImageData(size, size);
			let u32 = new Uint32Array(imageData.data.buffer)
			for (var i = 0; i < (size * size); i++) {
				u32[i] = this.data[i];
			}

			return imageData
		}

		randomize() {
			let size = this.size;
			for (var i = 0; i < (size * size); i++) {
				this.data[i] = Automat.fromRGB([Math.floor(Math.random() * 256),Math.floor(Math.random() * 256),Math.floor(Math.random() * 256)]);
			}
		}

		static toRGB(color) {
			return [(color >> 0) & 0xff, (color >> 8) & 0xff, (color >> 16) & 0xff];
		}

		static fromRGB(color) {
			return (((color[0] & 0xff)) |
			((color[1] & 0xff) << 8) |
			((color[2] & 0xff) << 16) |
			(0xff) << 24);
		}

		static greyScale(color) {
			let rgb = this.toRGB(color);
			let avg = (rgb[0] + rgb[1] + rgb[2]) / 3;
			u32[i] = this.fromRGB([avg,avg,avg]);
		}
	}

	class Comparator {

		static colorFire(x, y, kernel) {
			let values = kernel.map( c => Automat.toRGB(c));

			let value = values[4];
			let newValue = value;

			let idxs = [x + y, y + x + 1, x + y + 2];

			for (var j = 0; j < idxs.length; j++) {
				let i = idxs[j] % 3;
				let avg = Math.floor((values[0][i] + values[1][i] + values[2][i] + values[3][i] + values[5][i] + values[6][i] + values[7][i] + values[8][i]) / 8);

				let next = (i + 1) % 3;

				let diff = value[i] - avg;

				if (diff == 0) {
					newValue[i] = values[i][i];
				}
				else if(Math.abs(diff) > 48) {
					newValue = values[i+6];
				}
				if (value[i] < avg) {
					newValue[next]++;
				}
				else if (value[i] > avg) {
					newValue[next]--;
				}
			}

			return Automat.fromRGB(newValue);
		}

		static colorFall(x, y, kernel) {
			let values = kernel.map( c => Automat.toRGB(c));

			let value = values[4];
			let newValue = value;

			let idxs = [x + y, y + x + 1, x + y + 2];

			for (var j = 0; j < idxs.length; j++) {
				let i = idxs[j] % 3;
				let avg = Math.floor((values[0][i] + values[1][i] + values[2][i] + values[3][i] + values[5][i] + values[6][i] + values[7][i] + values[8][i]) / 8);

				let next = (i + 1) % 3;

				let diff = value[i] - avg;

				if (diff == 0) {
					newValue[i] = values[i][i];
				}
				else if(Math.abs(diff) < 48) {
					newValue = values[i];
				}
				if (value[i] < avg) {
					newValue[next]++;
				}
				else if (value[i] > avg) {
					newValue[next]--;
				}
			}

			return Automat.fromRGB(newValue);
		}

	}

	let scaleImageData = function(imgDat1, scale) {
		var imgDat2 = new ImageData(imgDat1.width * scale, imgDat1.height * scale);
		var pix1 = new Uint32Array(imgDat1.data.buffer);
		var pix2 = new Uint32Array(imgDat2.data.buffer);
		var canvasWidth1 = imgDat1.width;
		var canvasWidth2 = imgDat2.width;
		for (let x = 0; x < imgDat1.width; ++x) {
			for (let y = 0; y < imgDat1.height; ++y) {
				var idx = y * imgDat1.width + x;
				for (let i = 0; i < scale; ++i) {
					for (let j = 0; j < scale; ++j) {
						pix2[(((y * scale) + j) * imgDat2.width) + (x * scale) + i] = pix1[idx];
					}
				}
			}
		}
		return imgDat2
	}

	var currentAutomat = null;

	function setup(func) {
		currentAutomat = null;
		currentAutomat = new Automat(256, func);
	}

	function init() {
		setup(Comparator.colorFire);
		render();

	}

	function render() {
		currentAutomat.tick();
		let data = currentAutomat.render();

		let canvas = document.getElementById("canvas");
		let ctx = canvas.getContext('2d');
		ctx.putImageData(scaleImageData(data,2), 0, 0);
		window.requestAnimationFrame(render);
	}

</script>

</head>
<body onload="init();">

	<canvas id="canvas" width=512 height=512 > </canvas><br/>
	<button onclick="setup(Comparator.colorFire)">ColorFire</button>
	<button onclick="setup(Comparator.colorFall)">ColorFall</button>

</body>
</html>